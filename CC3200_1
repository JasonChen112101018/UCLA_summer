#include <WiFi.h>
#include <WiFiUdp.h>

char ssid[] = "CC3200_AP";
char password[] = "12345678";

WiFiUDP Udp;
IPAddress clientIP;
unsigned int localPort = 8888;

char incomingPacket[128];

void setup() {
  Serial.begin(115200);
  delay(1000);

  // 啟動 Access Point 模式
  WiFi.beginNetwork(ssid, password);
  WiFi.config(IPAddress(192, 168, 4, 1));

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nAP started. IP: ");
  Serial.println(WiFi.localIP());

  Udp.begin(localPort);
}

void loop() {
  int packetSize = Udp.parsePacket();
  if (packetSize) {
    int len = Udp.read(incomingPacket, sizeof(incomingPacket) - 1);
    if (len > 0) {
      incomingPacket[len] = '\0';
    }

    clientIP = Udp.remoteIP();  // 紀錄 Flutter App 的 IP
    Serial.print("Received from Flutter: ");
    Serial.println(incomingPacket);

    // 模擬處理 + 回傳
    if (strcmp(incomingPacket, "start") == 0) {
      sendToFlutter("WCE started");
    } else if (strcmp(incomingPacket, "status") == 0) {
      sendToFlutter("Status OK");
    } else {
      sendToFlutter("Unknown command");
    }
  }
}

void sendToFlutter(const char* msg) {
  Udp.beginPacket(clientIP, 8889);  // Flutter 應監聽此 Port
  Udp.write(msg);
  Udp.endPacket();
}

